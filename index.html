<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mercersburg Robotics AI Tutor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface-hover: #22263a;
      --border: #2a2e3f;
      --text: #e1e4ed;
      --text-dim: #8b8fa3;
      --accent: #4f8ff7;
      --accent-dim: #3a6bc5;
      --green: #3dd68c;
      --yellow: #f5c542;
      --red: #f55858;
      --orange: #f5953b;
      --purple: #a371f7;
      --code-bg: #161822;
      --user-bg: #273250;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ===================== HEADER ===================== */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }
    .header-logo { font-size: 28px; }
    .header-title {
      font-weight: 700;
      font-size: 16px;
    }
    .header-subtitle {
      font-size: 12px;
      color: var(--text-dim);
    }

    /* ===================== TOOLBAR ===================== */
    .toolbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 8px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }
    .toolbar-label {
      font-size: 12px;
      color: var(--text-dim);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Platform buttons */
    .platform-btns { display: flex; gap: 6px; }
    .platform-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .platform-btn:hover { border-color: var(--accent); color: var(--text); }
    .platform-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
      font-weight: 600;
    }

    /* Challenge selector */
    .challenge-divider {
      width: 1px;
      height: 24px;
      background: var(--border);
      margin: 0 4px;
    }
    .challenge-select {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
      cursor: pointer;
      max-width: 320px;
    }
    .challenge-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Prerequisite banner */
    .prereq-banner {
      background: #2a1f00;
      border: 1px solid #4a3500;
      border-radius: 8px;
      margin: 8px 20px;
      padding: 10px 14px;
      font-size: 12px;
      line-height: 1.5;
      display: none;
      flex-shrink: 0;
    }
    .prereq-banner.visible { display: block; }
    .prereq-banner .prereq-title {
      font-weight: 700;
      color: var(--yellow);
      margin-bottom: 4px;
    }
    .prereq-banner .prereq-body {
      color: #d4b44a;
    }

    /* ===================== CHAT ===================== */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Welcome screen */
    .welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      text-align: center;
      gap: 16px;
      padding: 40px 20px;
    }
    .welcome-icon { font-size: 56px; }
    .welcome h2 {
      font-size: 22px;
      font-weight: 700;
    }
    .welcome p {
      color: var(--text-dim);
      max-width: 480px;
      line-height: 1.6;
    }
    .welcome-hints {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      max-width: 460px;
      margin-top: 8px;
    }
    .hint-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      text-align: left;
      transition: all 0.2s;
    }
    .hint-btn:hover {
      background: var(--surface-hover);
      border-color: var(--accent);
    }
    .hint-emoji { font-size: 18px; }

    /* Messages */
    .message {
      max-width: 80%;
      line-height: 1.6;
      font-size: 14px;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; } }

    .message.user {
      align-self: flex-end;
      background: var(--user-bg);
      border-radius: 16px 16px 4px 16px;
      padding: 10px 16px;
    }
    .message.bot {
      align-self: flex-start;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px 16px 16px 4px;
      padding: 12px 16px;
    }

    /* Markdown rendering in bot messages */
    .message.bot code {
      background: var(--code-bg);
      font-family: 'JetBrains Mono', monospace;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
    .message.bot pre {
      background: var(--code-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      overflow-x: auto;
      margin: 8px 0;
    }
    .message.bot pre code {
      background: none;
      padding: 0;
      font-size: 12px;
      line-height: 1.5;
    }
    .message.bot strong { color: var(--accent); font-weight: 600; }
    .message.bot p { margin: 6px 0; }
    .message.bot ul, .message.bot ol { margin: 6px 0; padding-left: 20px; }
    .message.bot li { margin: 4px 0; }
    .message.bot h3, .message.bot h4 { margin-top: 12px; margin-bottom: 4px; }

    /* Typing indicator */
    .typing {
      display: none;
      align-self: flex-start;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px 16px 16px 4px;
    }
    .typing.visible { display: flex; gap: 4px; }
    .typing span {
      width: 8px; height: 8px;
      background: var(--text-dim);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* ===================== INPUT ===================== */
    .input-area {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 12px 20px;
      flex-shrink: 0;
    }
    .input-wrapper {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 12px;
    }
    .input-wrapper:focus-within { border-color: var(--accent); }
    .input-field {
      flex: 1;
      background: none;
      border: none;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      resize: none;
      outline: none;
      max-height: 120px;
      line-height: 1.5;
    }
    .send-btn {
      background: var(--accent);
      border: none;
      color: #fff;
      width: 34px; height: 34px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .send-btn:hover { background: var(--accent-dim); }
    .send-btn:disabled { opacity: 0.4; cursor: default; }
    .send-btn svg { width: 18px; height: 18px; fill: #fff; }

    .input-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-dim);
    }
    .clear-btn {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 11px;
      font-family: inherit;
    }
    .clear-btn:hover { color: var(--red); }

    /* ===================== RESPONSIVE ===================== */
    @media (max-width: 600px) {
      .header { padding: 10px 12px; }
      .toolbar { padding: 8px 12px; }
      .chat-area { padding: 12px; }
      .input-area { padding: 10px 12px; }
      .message { max-width: 92%; }
      .challenge-select { max-width: 180px; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <span class="header-logo">ü§ñ</span>
    <div>
      <div class="header-title">Mercersburg Robotics AI Tutor</div>
      <div class="header-subtitle">Your 24/7 debugging partner</div>
    </div>
  </div>

  <!-- TOOLBAR: Platform + Challenge Selector -->
  <div class="toolbar">
    <span class="toolbar-label">Platform:</span>
    <div class="platform-btns">
      <button class="platform-btn active" data-platform="zumo">Zumo 32U4</button>
      <button class="platform-btn" data-platform="3pi">3Pi+ 32U4</button>
      <button class="platform-btn" data-platform="zircon">Zircon Soccer</button>
    </div>

    <div class="challenge-divider"></div>

    <span class="toolbar-label">Working on:</span>
    <select class="challenge-select" id="challengeSelect" onchange="onChallengeChange()">
      <option value="">‚Äî Select a challenge (optional) ‚Äî</option>

      <optgroup label="Lesson 1: Hello Robot">
        <option value="1.1">1.1 Change the Message (Easy ‚≠ê)</option>
        <option value="1.2">1.2 Change the Beep (Easy ‚≠ê)</option>
        <option value="1.3">1.3 More Blinks (Medium ‚≠ê‚≠ê)</option>
        <option value="1.4">1.4 Longer Movement (Medium ‚≠ê‚≠ê)</option>
        <option value="1.5">1.5 Victory Jingle (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="1.6">1.6 Battery Check (Hard ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 2: Read Code Like A Pro">
        <option value="2.1">2.1 The Broken Code (Easy ‚≠ê)</option>
        <option value="2.2">2.2 Battery Screen (Easy ‚≠ê)</option>
        <option value="2.3">2.3 Button Counter (Medium ‚≠ê‚≠ê)</option>
        <option value="2.4">2.4 Scrolling Text (Hard ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 3: Motors & TRIM">
        <option value="3.1">3.1 Add a Spin Test (Easy ‚≠ê)</option>
        <option value="3.2">3.2 Variable Speed Test (Easy ‚≠ê)</option>
        <option value="3.3">3.3 Battery Warning System (Medium ‚≠ê‚≠ê)</option>
        <option value="3.4">3.4 Save TRIM to Code (Medium ‚≠ê‚≠ê)</option>
        <option value="3.5">3.5 Drive a Square (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="3.6">3.6 Auto-TRIM Preview (Expert ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 4: Line Sensors">
        <option value="4.1">4.1 Threshold Detection (Easy ‚≠ê)</option>
        <option value="4.2">4.2 Sensor-to-LED Mapping (Easy ‚≠ê)</option>
        <option value="4.3">4.3 Hysteresis / Anti-Flicker (Medium ‚≠ê‚≠ê)</option>
        <option value="4.4">4.4 Edge Detection Warning (Medium ‚≠ê‚≠ê)</option>
        <option value="4.5">4.5 Simple Line Follower Preview (Hard ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 5: Proximity Sensors">
        <option value="5.1">5.1 Detection Counter (Easy ‚≠ê)</option>
        <option value="5.2">5.2 Direction Indicator LEDs (Easy ‚≠ê)</option>
        <option value="5.3">5.3 Proximity-Based Beep Speed (Medium ‚≠ê‚≠ê)</option>
        <option value="5.4">5.4 All-Around Detection Warning (Medium ‚≠ê‚≠ê)</option>
        <option value="5.5">5.5 Social Distancing Robot (Medium ‚≠ê‚≠ê)</option>
        <option value="5.6">5.6 Simple Obstacle Avoidance (Hard ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 6: Encoders">
        <option value="6.1">6.1 The Square (Easy ‚≠ê)</option>
        <option value="6.2">6.2 The Triangle (Easy ‚≠ê)</option>
        <option value="6.3">6.3 The Pentagon (Medium ‚≠ê‚≠ê)</option>
        <option value="6.4">6.4 Basketball Suicide Drill (Medium ‚≠ê‚≠ê)</option>
        <option value="6.5">6.5 The Odometer (Medium ‚≠ê‚≠ê)</option>
        <option value="6.6">6.6 Smooth Stopping (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="6.7">6.7 Smooth Acceleration (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="6.8">6.8 Trapezoidal Motion Profile (Expert ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 7: Code Organization">
        <option value="7.1">7.1 Add Reverse Driving (Easy ‚≠ê)</option>
        <option value="7.2">7.2 Add Turn Helpers (Easy ‚≠ê)</option>
        <option value="7.3">7.3 Create RobotDisplay Module (Medium ‚≠ê‚≠ê)</option>
        <option value="7.4">7.4 Add Speed Modes to Config (Medium ‚≠ê‚≠ê)</option>
        <option value="7.5">7.5 Create RobotSensors Skeleton (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="7.6">7.6 Square Navigation All Modules (Hard ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 8: P-Control Line Following">
        <option value="8.1">8.1 Speed Optimization (Easy ‚≠ê)</option>
        <option value="8.2">8.2 Wiggle Test (Easy ‚≠ê)</option>
        <option value="8.3">8.3 Gap Gauntlet (Medium ‚≠ê‚≠ê)</option>
        <option value="8.4">8.4 Display Position Bar (Medium ‚≠ê‚≠ê)</option>
        <option value="8.5">8.5 Adaptive Kp Controller (Hard ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 9: Intersections & Dead Ends">
        <option value="9.1">9.1 LED Turn Indicators (Easy ‚≠ê)</option>
        <option value="9.2">9.2 Line-Seeking Turns (Medium ‚≠ê‚≠ê)</option>
        <option value="9.3">9.3 Encoder-Based Turns (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="9.4">9.4 Debounced Detection (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="9.5">9.5 Right-Hand Rule Maze Solver (Expert ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 10: Obstacles">
        <option value="10.1">10.1 LED Turn Indicators (Easy ‚≠ê)</option>
        <option value="10.2">10.2 Adaptive Forward Duration (Medium ‚≠ê‚≠ê)</option>
        <option value="10.3">10.3 Both-Direction Avoidance (Medium ‚≠ê‚≠ê)</option>
        <option value="10.4">10.4 Obstacle + Intersection Combo (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="10.5">10.5 Encoder-Based Avoidance (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="10.6">10.6 Alternating Avoidance Direction (Expert ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 11: Edge Detection">
        <option value="11.1">11.1 Gap Length Detective (Easy ‚≠ê)</option>
        <option value="11.2">11.2 Recovery Search Pattern (Medium ‚≠ê‚≠ê)</option>
        <option value="11.3">11.3 Ramp Detection (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="11.4">11.4 The Gauntlet ‚Äî Competition Track (Hard ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 12: Rescue Zone">
        <option value="12.1">12.1 Calibration Master (Easy ‚≠ê)</option>
        <option value="12.2">12.2 Better Search Pattern (Medium ‚≠ê‚≠ê)</option>
        <option value="12.3">12.3 Victim Counter with Limit (Medium ‚≠ê‚≠ê)</option>
        <option value="12.4">12.4 Distinguish Living vs Dead (Hard ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 13: Competition Prep">
        <option value="13.1">13.1 Reliability Marathon (Easy ‚≠ê)</option>
        <option value="13.2">13.2 Environmental Gauntlet (Medium ‚≠ê‚≠ê)</option>
        <option value="13.3">13.3 Battery Drain Test (Medium ‚≠ê‚≠ê)</option>
        <option value="13.4">13.4 The Pressure Test (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="13.5">13.5 Documentation Challenge (Hard ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>

      <optgroup label="Lesson 14: Advanced PID Control">
        <option value="14.1">14.1 High-Speed Smooth Following (Easy ‚≠ê)</option>
        <option value="14.2">14.2 PD vs PID Comparison (Easy ‚≠ê)</option>
        <option value="14.3">14.3 Encoder-Based Precise Turns (Medium ‚≠ê‚≠ê)</option>
        <option value="14.4">14.4 Constant Speed Control (Medium ‚≠ê‚≠ê)</option>
        <option value="14.5">14.5 Gain Scheduling (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="14.6">14.6 PID Class Refactoring (Hard ‚≠ê‚≠ê‚≠ê)</option>
        <option value="14.7">14.7 Data Logging and Analysis (Expert ‚≠ê‚≠ê‚≠ê)</option>
      </optgroup>
    </select>
  </div>

  <!-- PREREQUISITE BANNER -->
  <div class="prereq-banner" id="prereqBanner">
    <div class="prereq-title">‚ö†Ô∏è Prerequisites for this challenge:</div>
    <div class="prereq-body" id="prereqBody"></div>
  </div>

  <!-- CHAT -->
  <div class="chat-area" id="chatContainer">
    <div class="welcome" id="welcomeScreen">
      <div class="welcome-icon">ü§ñ</div>
      <h2>Need help with your robot?</h2>
      <p>I know your curriculum, your assignments, and your robots.
      Paste your error message, describe what's going wrong, or ask a concept question.</p>
      <div class="welcome-hints">
        <button class="hint-btn" onclick="sendHint(this)">
          <span class="hint-emoji">üî¥</span>
          My code won't compile and I don't understand the error
        </button>
        <button class="hint-btn" onclick="sendHint(this)">
          <span class="hint-emoji">üîß</span>
          My robot compiles but doesn't do what I expect
        </button>
        <button class="hint-btn" onclick="sendHint(this)">
          <span class="hint-emoji">üì°</span>
          How do the line sensors work?
        </button>
        <button class="hint-btn" onclick="sendHint(this)">
          <span class="hint-emoji">üí°</span>
          I'm stuck on a challenge and need a hint
        </button>
      </div>
    </div>
  </div>

  <!-- TYPING INDICATOR -->
  <div class="typing" id="typingIndicator">
    <span></span><span></span><span></span>
  </div>

  <!-- INPUT -->
  <div class="input-area">
    <div class="input-wrapper">
      <textarea
        class="input-field"
        id="userInput"
        placeholder="Paste your error or ask a question..."
        rows="1"
        onkeydown="handleKey(event)"
        oninput="autoResize(this)"
      ></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
    <div class="input-footer">
      <span>Press Enter to send ¬∑ Shift+Enter for new line</span>
      <button class="clear-btn" onclick="clearChat()">Clear chat</button>
    </div>
  </div>

  <script>
    // ==========================================
    // CONFIGURATION ‚Äî UPDATE THIS URL
    // ==========================================
    // Replace with your actual Cloudflare Worker URL
  const WORKER_URL = https://zumosupport.weymuthd.workers.dev;

    // ==========================================
    // PREREQUISITE DATA (client-side display only)
    // The REAL prerequisite logic lives in the worker's system prompt.
    // This is just for the yellow banner hint.
    // ==========================================
    const PREREQ_HINTS = {
      // Lesson 6
      "6.8": "Requires Challenge 6.6 (Smooth Stopping) AND 6.7 (Smooth Acceleration) ‚Äî you need both working before combining them.",
      // Lesson 7
      "7.6": "Requires Challenge 7.1 (Reverse Driving) + 7.2 (Turn Helpers). Ideally also 7.3 (RobotDisplay). All modules must compile.",
      // Lesson 8 (needs L7 modules)
      "8.1": "Your L7 modules must be working: RobotConfig.h, RobotMotion, RobotSensors. Plus the L8 followLine() code.",
      "8.2": "Needs your L8 base code with followLine() and tuned KP value.",
      "8.3": "Needs handleGap() from the L8 build section working. Make sure MAX_GAP_TIME is in RobotConfig.h.",
      "8.4": "Needs readLinePosition() from L8. You'll use the OLED display and map() function.",
      "8.5": "Needs followLine() and readLinePosition(). ‚ö†Ô∏è Common bug: using the constant KP instead of your adjustable currentKp variable!",
      // Lesson 9 (needs L8 line following)
      "9.1": "Needs the L9 state machine working (AT_INTERSECTION, EXECUTING_TURN states).",
      "9.2": "Needs L9 turn functions + L8 line sensor reading for the hybrid approach.",
      "9.3": "Needs L6 encoder knowledge! You must understand ENCODER_COUNTS_90 and add encoder #includes.",
      "9.4": "Needs L9 checkForIntersection() working reliably before adding debounce logic.",
      "9.5": "Advanced! Needs FULL understanding of all intersection types and turn functions from L9.",
      // Lesson 10 (needs L9 + L5)
      "10.1": "Needs the L10 obstacle avoidance state machine phases working.",
      "10.2": "Needs L10 checkForObstacle() and PHASE_DRIVE_PAST state.",
      "10.3": "Needs L10 obstacle phases AND L5 understanding of left vs right proximity sensor values.",
      "10.4": "‚ö†Ô∏è HARDEST COMBO ‚Äî needs BOTH obstacle AND intersection state machines working together. Get each working separately first!",
      "10.5": "Needs L10 obstacle phases + L6 encoder concepts (COUNTS_PER_90_TURN, COUNTS_FORWARD).",
      "10.6": "Needs L10 obstacle avoidance working. Uses counter variable and modulo (%) operator.",
      // Lesson 11 (needs L10)
      "11.1": "Needs L11 edge/gap detection states + L6 encoder counts for distance calculation.",
      "11.2": "Needs L11 LINE_LOST state + L6 encoder-based turns (45¬∞/90¬∞ rotations).",
      "11.3": "Needs L11 gap detection + LSM303 accelerometer library (NEW hardware ‚Äî not in prior lessons).",
      "11.4": "Requires Challenge 11.1 (gap measurement) working first. Build a full test track.",
      // Lesson 12 (needs L11)
      "12.1": "Needs L12 silver detection code working. Test under multiple lighting conditions.",
      "12.2": "Needs L12 search pattern + L5 proximity sensors for wall detection + L6 encoder tracking.",
      "12.3": "Needs L12 performRescue() and rescue state machine working.",
      "12.4": "Requires Challenge 12.1 (Calibration Master) done first ‚Äî silver detection must be reliable!",
      // Lesson 13 (needs L1-L12)
      "13.1": "Needs your COMPLETE working robot ‚Äî line following, intersections, obstacles, edges. All of L1-L12.",
      "13.2": "Complete robot + ability to recalibrate thresholds for different lighting.",
      "13.3": "Complete robot + readBatteryMillivolts() for monitoring.",
      "13.4": "Complete robot + knowledge of competition rules.",
      "13.5": "Knowledge of ALL threshold values and behaviors from L4-L12.",
      // Lesson 14 (needs L8)
      "14.1": "Needs L8 P-control working + L14 PID extension (KP, KI, KD constants).",
      "14.2": "Needs L14 PID followLine(). Compare with KI=0 for PD mode.",
      "14.3": "Needs L6 encoder counts (~370 counts per 90¬∞) + L14 PID concepts.",
      "14.4": "Needs L6 encoder-based speed measurement + L14 PID concepts.",
      "14.5": "Requires Challenge 14.1 (basic PID tuning) done first. Multiple gain sets needed.",
      "14.6": "Needs L14 PID code + C++ class syntax (constructor, methods, private members).",
      "14.7": "Needs L14 PID variables + Serial output + external analysis tool (Excel/Python).",
    };

    // ==========================================
    // STATE
    // ==========================================
    let conversationHistory = [];
    let currentPlatform = "zumo";
    let currentChallenge = "";
    let isLoading = false;

    const platformNames = {
      zumo: "Zumo 32U4 (Line Rescue)",
      "3pi": "3Pi+ 32U4 (Maze/Line Rescue)",
      zircon: "Zircon Soccer Robot",
    };

    // ==========================================
    // PLATFORM SWITCHING
    // ==========================================
    document.querySelectorAll(".platform-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".platform-btn").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentPlatform = btn.dataset.platform;
      });
    });

    // ==========================================
    // CHALLENGE SELECTOR
    // ==========================================
    function onChallengeChange() {
      const select = document.getElementById("challengeSelect");
      currentChallenge = select.value;
      const banner = document.getElementById("prereqBanner");
      const body = document.getElementById("prereqBody");

      if (currentChallenge && PREREQ_HINTS[currentChallenge]) {
        body.textContent = PREREQ_HINTS[currentChallenge];
        banner.classList.add("visible");
      } else {
        banner.classList.remove("visible");
      }
    }

    // ==========================================
    // MESSAGING
    // ==========================================
    function addMessage(role, text) {
      const welcome = document.getElementById("welcomeScreen");
      if (welcome) welcome.remove();

      const container = document.getElementById("chatContainer");
      const div = document.createElement("div");
      div.className = `message ${role}`;

      if (role === "bot") {
        div.innerHTML = renderMarkdown(text);
      } else {
        div.textContent = text;
      }

      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function renderMarkdown(text) {
      // Simple markdown rendering
      let html = text
        // Code blocks
        .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>')
        // Inline code
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // Bold
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        // Italic
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        // Headers
        .replace(/^### (.+)$/gm, '<h4>$1</h4>')
        .replace(/^## (.+)$/gm, '<h3>$1</h3>')
        // Lists
        .replace(/^\- (.+)$/gm, '<li>$1</li>')
        .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
        // Paragraphs (double newline)
        .replace(/\n\n/g, '</p><p>')
        // Single newlines
        .replace(/\n/g, '<br>');

      // Wrap loose <li> in <ul>
      html = html.replace(/(<li>.*?<\/li>(\s*<br>)*)+/g, (match) => {
        return '<ul>' + match.replace(/<br>/g, '') + '</ul>';
      });

      return '<p>' + html + '</p>';
    }

    function showTyping() {
      document.getElementById("typingIndicator").classList.add("visible");
      document.getElementById("chatContainer").scrollTop =
        document.getElementById("chatContainer").scrollHeight;
    }

    function hideTyping() {
      document.getElementById("typingIndicator").classList.remove("visible");
    }

    function sendHint(btn) {
      const text = btn.textContent.trim();
      document.getElementById("userInput").value = text;
      sendMessage();
    }

    function handleKey(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function autoResize(el) {
      el.style.height = "auto";
      el.style.height = Math.min(el.scrollHeight, 120) + "px";
    }

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if (!text || isLoading) return;

      isLoading = true;
      document.getElementById("sendBtn").disabled = true;
      input.value = "";
      input.style.height = "auto";

      // Add platform context to first message, and challenge context if selected
      const isFirstMessage = conversationHistory.length === 0;
      let userContent = text;
      if (isFirstMessage) {
        let prefix = `[Platform: ${platformNames[currentPlatform]}]`;
        if (currentChallenge) {
          prefix += `\n[Currently working on: Challenge ${currentChallenge}]`;
        }
        userContent = prefix + "\n\n" + text;
      }

      addMessage("user", text);
      conversationHistory.push({ role: "user", content: userContent });

      showTyping();

      try {
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messages: conversationHistory,
            currentChallenge: currentChallenge || null,
          }),
        });

        hideTyping();

        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          throw new Error(errorData.error?.message || `HTTP ${res.status}`);
        }

        const data = await res.json();

        if (data.error) {
          throw new Error(data.error.message || "API error");
        }

        const reply = data.content
          .map((block) => (block.type === "text" ? block.text : ""))
          .filter(Boolean)
          .join("\n");

        conversationHistory.push({ role: "assistant", content: reply });
        addMessage("bot", reply);
      } catch (err) {
        hideTyping();
        addMessage(
          "bot",
          `**Oops ‚Äî something went wrong.** The tutor couldn't process your question. This usually means the server is temporarily unavailable.\n\nError: \`${err.message}\`\n\nTry again in a moment, or let your instructor know if this keeps happening.`
        );
      }

      isLoading = false;
      document.getElementById("sendBtn").disabled = false;
      input.focus();
    }

    // ==========================================
    // CLEAR CHAT
    // ==========================================
    function clearChat() {
      conversationHistory = [];
      const container = document.getElementById("chatContainer");
      container.innerHTML = `
        <div class="welcome" id="welcomeScreen">
          <div class="welcome-icon">ü§ñ</div>
          <h2>Need help with your robot?</h2>
          <p>I know your curriculum, your assignments, and your robots.
          Paste your error message, describe what's going wrong, or ask a concept question.</p>
          <div class="welcome-hints">
            <button class="hint-btn" onclick="sendHint(this)">
              <span class="hint-emoji">üî¥</span>
              My code won't compile and I don't understand the error
            </button>
            <button class="hint-btn" onclick="sendHint(this)">
              <span class="hint-emoji">üîß</span>
              My robot compiles but doesn't do what I expect
            </button>
            <button class="hint-btn" onclick="sendHint(this)">
              <span class="hint-emoji">üì°</span>
              How do the line sensors work?
            </button>
            <button class="hint-btn" onclick="sendHint(this)">
              <span class="hint-emoji">üí°</span>
              I'm stuck on a challenge and need a hint
            </button>
          </div>
        </div>
      `;
    }
  </script>

</body>
</html>
